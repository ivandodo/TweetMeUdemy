{% extends "base.html" %}

{% block content %}
    <div class="row">
        <div class="col-sm-3 col-xs-12" style="background-color:red;">
            <h1>{{request.user}}</h1>
        </div>
        <div class="col-sm-9">
            {% if not request.GET.q %}
                <div class="col-sm-12">
                    {% include "tweets/form.html" with form=create_form action_url=create_url button_title="Tweet" form_id="tweet-form" %}
                    <hr/>
                </div>
            {% endif %}

            <div id="tweet-container">

            </div>
            <!--{% for object in object_list %}-->
                <!--<div class="col-sm-9">-->
                    <!--<h4>{{object.content}}</h4><br/>-->
                    <!--via {{object.user}} | {{object.timestamp|timesince}} ago | <a href='{{ object.get_absolute_url }}'>View</a>-->
                <!--</div>-->
                <!--<div class="col-sm-12">-->
                    <!--<hr/>-->
                <!--</div>-->
                <!--{% empty %}-->
                    <!--{% if request.GET.q %}-->
                        <!--<p>No tweets found.</p>-->
                    <!--{% else %}-->
                        <!--<p>No tweets yet.</p>-->
                    <!--{% endif %}-->
            <!--{% endfor %}-->
        </div>
        <div class="col-sm-8 col-sm-offset-2">

        </div>
    </div>
{% endblock content %}

{% block script %}
<script>
    function getParameterByName(name, url) {
        if (!url) {
          url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    $(document).ready(function() {
        var query = getParameterByName('q');
        var tweetList = [];

        function attachTweet(tweetValue, prepend){
            var tweetContent = tweetValue.content;
            var tweetUser =  tweetValue.user;
            var tweetSince = tweetValue.time_since;
            var tweetFormattedHtml =  "<div class='col-sm-9'>"
                        + "<b>" + tweetContent + "</b><br/> via "
                        + tweetUser.username +  " | " + tweetSince + " | "
                        + "<a href='#'>View</a></div><div class='col-sm-12'><hr/></div>"
            if (prepend){
                $("#tweet-container").prepend(tweetFormattedHtml);
            }
            else{
                $("#tweet-container").append(tweetFormattedHtml);
            }
        }

        function parseTweets(){
            if (tweetList == 0){
                $('#tweet-container').text("No tweets found");
            }
            else{
                $.each(tweetList, function(key, value){
                        var tweetKey = key;
                        var tweetContent = value.content;
                        var tweetUser =  value.user;
                        var tweetSince = value.time_since;
                        $("#tweet-container").append(
                            "<div class='col-sm-9'>"
                                + "<b>" + tweetContent + "</b><br/> via "
                                + tweetUser.username +  " | " + tweetSince + " | "
                                + "<a href='#'>View</a></div><div class='col-sm-12'><hr/></div>"
                        )
                    })
            }
        }

        function fetchTweets(){
            $.ajax({
                url:"/api/tweet",
                data: {
                    "q": query
                },
                method: "GET",
                success: function(data){
                    tweetList = data;
                    parseTweets();
                },
                error: function(data){
                    console.log("error");
                    console.log(data);
                }
            });
        }

        fetchTweets();

        var charsStart = 140;
        var charsCurrent = 0;
        $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>");

        $("#tweet-form textarea").keyup(function(event){
            var tweetValue = $(this).val()
            charsCurrent = charsStart - tweetValue.length;
            var spanChars = $('#tweetCharsLeft')
            spanChars.text(charsCurrent);

            if (charsCurrent > 0){
                //remove classes
                spanChars.removeClass("grey-color");
                spanChars.removeClass("red-color");
            } else if (charsCurrent == 0){
                spanChars.addClass("grey-color");
            } else if (charsCurrent < 0){
                spanChars.addClass("red-color");
            }


         })

        $("#tweet-form").submit(function(event){
            event.preventDefault();
            this_ = $(this);
            var formData = this_.serialize();

            if (charsCurrent >= 140) {

            } else {
                console.log("Cannot send, tweet too long!");
            }
        })
    });
</script>
{% endblock script %}